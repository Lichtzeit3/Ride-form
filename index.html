<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>羅東博愛醫院 x 永續通勤補助計畫</title>
  <style>
    @media (max-width: 430px) {
      html, body {
        padding-top: 0 !important;
        margin: 0;
        height: 100vh;
        overflow: hidden;
      }
      
      #form-container {
        margin: 0;
        padding: 0;
        height: 100vh;
        width: 100%;
        overflow-y: auto;
        box-sizing: border-box;
      }
      
      #fillout-form {
        width: 100% !important;
        min-height: calc(100vh - 20px); /* Use min-height with slight reduction */
      }
      
      #message {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        padding: 30px 10px;
        width: 80%;
        margin: 0;
        box-sizing: border-box;
        z-index: 1000;
      }
    }
  </style>
</head>
<body style="background-color: #F5F5F5; padding-top: 13vh; font-family: 'Heebo', '微軟正黑體', sans-serif; font-size: 20px; letter-spacing: 0.5px;">
  
  <!-- Fillout Form Container -->
  <div id="form-container" style="max-width: 800px; margin: auto;">
    <div data-fillout-id="pftwMqa9FDus" 
         data-fillout-embed-type="standard" 
         style="width:100%;height:500px;" 
         id="fillout-form" 
         data-fillout-inherit-parameters 
         data-fillout-dynamic-resize>
    </div>
    <script src="https://server.fillout.com/embed/v1/"></script>
  </div>
  
  <!-- Error/Status Messages -->
  <div id="message" style="color: #dc3545; display: none; text-align: center; max-width: 800px; margin: auto; font-size: 20px; padding: 20px;"></div>

<script>
console.log('=== SCRIPT STARTED ===');

function isChrome() {
  return /Chrome/.test(navigator.userAgent) && !/Edge/.test(navigator.userAgent);
}

// Simple device ID
function getDeviceId() {
  let id = localStorage.getItem('deviceId');
  if (!id) {
    id = 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);
    localStorage.setItem('deviceId', id);
    console.log('Created new device ID:', id);
  }
  console.log('Using device ID:', id);
  return id;
}

// Get today's date
function getToday() {
  const now = new Date();
  return now.toLocaleDateString('en-CA'); // YYYY-MM-DD in local time
}

// Get current period
function getPeriod() {
  const now = new Date();
  const hour = now.getHours();
  return (hour >= 6 && hour < 9) ? 'morning' : 'evening';
}

// Clean up expired submissions (older than 3 hours)
function cleanupExpiredSubmissions() {
  const deviceId = getDeviceId();
  const now = Date.now();
  const threeHours = 3 * 60 * 60 * 1000; // 3 hours in milliseconds
  
  // Check all localStorage keys for this device's submissions
  for (let i = localStorage.length - 1; i >= 0; i--) {
    const key = localStorage.key(i);
    if (key && key.startsWith(`submitted_${deviceId}_`)) {
      const submissionTime = localStorage.getItem(key);
      if (submissionTime && (now - parseInt(submissionTime)) > threeHours) {
        console.log('Removing expired submission:', key);
        localStorage.removeItem(key);
      }
    }
  }
}

// Simple scroll to top when keyboard likely disappears - MOBILE ONLY
function setupKeyboardHandling() {
  if (window.innerWidth > 430) return;
  
  // Scroll to top when user finishes with any input field
  document.addEventListener('focusout', (e) => {
    // Check if the focusout is from a form input
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
      // Small delay to let keyboard fully close, then scroll to top
      setTimeout(() => {
        window.scrollTo(0, 0);
        document.body.scrollTop = 0;
        document.documentElement.scrollTop = 0;
      }, 300);
    }
  });
}

// Force scroll reset after form submission - MOBILE ONLY  
function forceScrollReset() {
  if (window.innerWidth > 430) return;
  
  // Scroll to top
  window.scrollTo(0, 0);
  document.body.scrollTop = 0;
  document.documentElement.scrollTop = 0;
  
  // Force full layout recalculation
  setTimeout(() => {
    // Temporarily change and restore key CSS properties
    document.body.style.overflow = 'hidden';
    document.documentElement.style.overflow = 'hidden';
    
    // Force repaint
    document.body.offsetHeight;
    
    // Restore overflow settings
    document.body.style.overflow = '';
    document.documentElement.style.overflow = '';
    
    // Double-check scroll position
    window.scrollTo(0, 0);
  }, 150);
  
  // Mobile Chrome viewport fix
  if (isChrome() && window.innerWidth <= 430) {
    // Force container to use actual viewport height
    const container = document.getElementById('form-container');
    container.style.height = window.innerHeight + 'px';
    
    // Force viewport refresh with proper timing
    requestAnimationFrame(() => {
      window.dispatchEvent(new Event('resize'));
      container.style.height = '100vh';
      
      // Double-check scroll after browser processes
      setTimeout(() => {
        window.scrollTo(0, 0);
      }, 50);
    });
  }
}

// Check if submitted (with 3-hour expiration)
function hasSubmitted() {
  const key = 'submitted_' + getDeviceId() + '_' + getToday() + '_' + getPeriod();
  const submissionTime = localStorage.getItem(key);
  
  if (!submissionTime) {
    console.log('No previous submission found');
    return false;
  }
  
  const now = Date.now();
  const threeHours = 3 * 60 * 60 * 1000; // 3 hours in milliseconds
  const timeDiff = now - parseInt(submissionTime);
  
  if (timeDiff > threeHours) {
    console.log('Previous submission expired (older than 3 hours), removing it');
    localStorage.removeItem(key);
    return false;
  }
  
  console.log('Valid submission found within 3 hours');
  return true;
}

// Mark as submitted
function markSubmitted() {
  const key = 'submitted_' + getDeviceId() + '_' + getToday() + '_' + getPeriod();
  localStorage.setItem(key, Date.now().toString());
  console.log('Marked as submitted:', key);
}

// Show/hide functions
function showMessage(text, color) {
  console.log('Showing message:', text);
  document.getElementById('form-container').style.display = 'none';
  document.getElementById('message').style.display = 'block';
  document.getElementById('message').style.color = color || '#dc3545';
  document.getElementById('message').textContent = text;
}

function showForm() {
  console.log('Showing form');
  document.getElementById('form-container').style.display = 'block';
  document.getElementById('message').style.display = 'none';
}

// Main logic
function init() {
  console.log('=== INITIALIZING ===');
  
  // Clean up any expired submissions first
  cleanupExpiredSubmissions();
  
  // Setup keyboard handling for mobile
  setupKeyboardHandling();
  
  const deviceId = getDeviceId();
  
  // Get current date and time (local time) - Original V1 logic
  const now = new Date();
  const currentHour = now.getHours();
  const currentDate = now.toLocaleDateString('en-CA'); // YYYY-MM-DD in local time
  const isMorningPeriod = currentHour >= 0 && currentHour < 12; // 6 AM - 9 AM
  const isEveningPeriod = currentHour >= 12 && currentHour <= 23; // 4 PM - 6 PM
  const isAllowedTime = isMorningPeriod || isEveningPeriod;
  const timePeriod = isMorningPeriod ? 'morning' : 'evening';
  
  console.log('Device ID:', deviceId);
  console.log('Current hour:', currentHour);
  console.log('Current date:', currentDate);
  console.log('Time period:', timePeriod);
  console.log('Is allowed time:', isAllowedTime);

  // Check if form can be shown - Original V1 logic
  if (!isAllowedTime) {
    showMessage('此表單僅在上午6點至9點和下午4點至6點開放。');
    console.log('Form blocked: Outside allowed time');
    return;
  }
  
  // Check if already submitted
  if (hasSubmitted()) {
    showMessage('您今天已經在此時段提交過表單。');
    return;
  }
  
  // Show form
  showForm();
  
  // Listen for messages
  window.addEventListener('message', function(event) {
    console.log('Message received:', event.data);
    if (event.data && typeof event.data === 'object' && event.data.type) {
      if (event.data.type.includes('submit') || event.data.type.includes('Submit')) {
        console.log('SUBMISSION DETECTED!');
        markSubmitted();
        showMessage('謝謝！表單提交成功。', '#228B22');
        forceScrollReset();
      }
    }
  });
}

// Start when page loads
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', init);
} else {
  init();
}

console.log('=== SCRIPT SETUP COMPLETE ===');
</script>
</body>
</html>
