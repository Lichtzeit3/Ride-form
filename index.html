<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Uber Ride Form</title>
</head>
<body>
  <h1 style="text-align: center;">Uber Ride Form</h1>
  
  <!-- Fillout Form Container -->
  <div id="form-container" style="max-width: 800px; margin: auto;">
    <div data-fillout-id="pftwMqa9FDus" 
         data-fillout-embed-type="standard" 
         style="width:100%;height:500px;" 
         id="fillout-form" 
         data-fillout-inherit-parameters 
         data-fillout-dynamic-resize>
    </div>
    <script src="https://server.fillout.com/embed/v1/"></script>
  </div>
  
  <!-- Error/Status Messages -->
  <div id="message" style="color: red; display: none; text-align: center; max-width: 800px; margin: auto; font-size: 18px; padding: 20px;"></div>

<script>
console.log('=== SCRIPT STARTED ===');

// Simple device ID
function getDeviceId() {
  let id = localStorage.getItem('deviceId');
  if (!id) {
    id = 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);
    localStorage.setItem('deviceId', id);
    console.log('Created new device ID:', id);
  }
  console.log('Using device ID:', id);
  return id;
}

// Get today's date
function getToday() {
  const now = new Date();
  return now.toLocaleDateString('en-CA'); // YYYY-MM-DD in local time
}

// Get current period
function getPeriod() {
  const now = new Date();
  const hour = now.getHours();
  return (hour >= 6 && hour < 9) ? 'morning' : 'evening';
}

// Check if submitted
function hasSubmitted() {
  const key = 'submitted_' + getDeviceId() + '_' + getToday() + '_' + getPeriod();
  const result = localStorage.getItem(key) !== null;
  console.log('Checking submission key:', key);
  console.log('Has submitted:', result);
  return result;
}

// Mark as submitted
function markSubmitted() {
  const key = 'submitted_' + getDeviceId() + '_' + getToday() + '_' + getPeriod();
  localStorage.setItem(key, Date.now().toString());
  console.log('Marked as submitted:', key);
}

// Show/hide functions
function showMessage(text, color) {
  console.log('Showing message:', text);
  document.getElementById('form-container').style.display = 'none';
  document.getElementById('message').style.display = 'block';
  document.getElementById('message').style.color = color || 'red';
  document.getElementById('message').textContent = text;
}

function showForm() {
  console.log('Showing form');
  document.getElementById('form-container').style.display = 'block';
  document.getElementById('message').style.display = 'none';
}

// Main logic
function init() {
  console.log('=== INITIALIZING ===');
  
  const deviceId = getDeviceId();
  
  // Get current date and time (local time) - Original V1 logic
  const now = new Date();
  const currentHour = now.getHours();
  const currentDate = now.toLocaleDateString('en-CA'); // YYYY-MM-DD in local time
  const isMorningPeriod = currentHour >= 6 && currentHour < 9; // 6 AM - 9 AM
  const isEveningPeriod = currentHour >= 16 && currentHour < 18; // 4 PM - 6 PM
  const isAllowedTime = isMorningPeriod || isEveningPeriod;
  const timePeriod = isMorningPeriod ? 'morning' : 'evening';
  
  console.log('Device ID:', deviceId);
  console.log('Current hour:', currentHour);
  console.log('Current date:', currentDate);
  console.log('Time period:', timePeriod);
  console.log('Is allowed time:', isAllowedTime);

  // Check if form can be shown - Original V1 logic
  if (!isAllowedTime) {
    showMessage('This form is only accessible from 6 AM–9 AM and 4 PM–6 PM.');
    console.log('Form blocked: Outside allowed time');
    return;
  }
  
  // Check if already submitted
  if (hasSubmitted()) {
    showMessage('You have already submitted the form for this period today.');
    return;
  }
  
  // Show form
  showForm();
  
  // Listen for messages
  window.addEventListener('message', function(event) {
    console.log('Message received:', event.data);
    if (event.data && typeof event.data === 'object' && event.data.type) {
      if (event.data.type.includes('submit') || event.data.type.includes('Submit')) {
        console.log('SUBMISSION DETECTED!');
        markSubmitted();
        showMessage('Thank you! Form submitted successfully.', 'green');
      }
    }
  });
}

// Make everything global for testing
window.getDeviceId = getDeviceId;
window.hasSubmitted = hasSubmitted;
window.markSubmitted = markSubmitted;
window.showMessage = showMessage;
window.showForm = showForm;

// Test function
window.testBlock = function() {
  console.log('Testing block...');
  markSubmitted();
  showMessage('TEST: Marked as submitted. Refresh to see if blocked.', 'orange');
};

window.clearAll = function() {
  localStorage.clear();
  console.log('Cleared all data');
  location.reload();
};

window.debug = function() {
  console.log('=== DEBUG INFO ===');
  console.log('Device ID:', getDeviceId());
  console.log('Today:', getToday());
  console.log('Period:', getPeriod());
  console.log('Has Submitted:', hasSubmitted());
  console.log('LocalStorage:', localStorage);
};

console.log('=== FUNCTIONS DEFINED ===');
console.log('Available: window.testBlock(), window.clearAll(), window.debug()');

// Start
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', init);
} else {
  init();
}

console.log('=== SCRIPT SETUP COMPLETE ===');
</script>
</body>
</html>
