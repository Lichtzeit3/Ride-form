<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>羅東博愛醫院 x 永續通勤補助計畫</title>
</head>
<body style="background-color: #F5F5F5; padding-top: 13vh; font-family: 'Heebo', '微軟正黑體', sans-serif; font-size: 20px; letter-spacing: 0.5px;">
  
  <!-- Fillout Form Container -->
  <div id="form-container" style="max-width: 800px; margin: auto;">
    <div data-fillout-id="pftwMqa9FDus" 
         data-fillout-embed-type="standard" 
         style="width:100%;height:500px;" 
         id="fillout-form" 
         data-fillout-inherit-parameters 
         data-fillout-dynamic-resize>
    </div>
    <script src="https://server.fillout.com/embed/v1/"></script>
  </div>
  
  <!-- Error/Status Messages -->
  <div id="message" style="color: #dc3545; display: none; text-align: center; max-width: 800px; margin: auto; font-size: 20px; padding: 20px;"></div>

<script>
console.log('=== SCRIPT STARTED ===');

// Simple device ID
function getDeviceId() {
  let id = localStorage.getItem('deviceId');
  if (!id) {
    id = 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);
    localStorage.setItem('deviceId', id);
    console.log('Created new device ID:', id);
  }
  console.log('Using device ID:', id);
  return id;
}

// Get today's date
function getToday() {
  const now = new Date();
  return now.toLocaleDateString('en-CA'); // YYYY-MM-DD in local time
}

// Get current period
function getPeriod() {
  const now = new Date();
  const hour = now.getHours();
  return (hour >= 6 && hour < 9) ? 'morning' : 'evening';
}

// Clean up expired submissions (older than 1 minute - FOR TESTING)
function cleanupExpiredSubmissions() {
  const deviceId = getDeviceId();
  const now = Date.now();
  const oneMinute = 1 * 60 * 1000; // 1 minute in milliseconds - FOR TESTING
  
  // Check all localStorage keys for this device's submissions
  for (let i = localStorage.length - 1; i >= 0; i--) {
    const key = localStorage.key(i);
    if (key && key.startsWith(`submitted_${deviceId}_`)) {
      const submissionTime = localStorage.getItem(key);
      if (submissionTime && (now - parseInt(submissionTime)) > oneMinute) {
        console.log('Removing expired submission:', key);
        localStorage.removeItem(key);
      }
    }
  }
}

// Check if submitted (with 1-minute expiration - FOR TESTING)
function hasSubmitted() {
  const key = 'submitted_' + getDeviceId() + '_' + getToday() + '_' + getPeriod();
  const submissionTime = localStorage.getItem(key);
  
  if (!submissionTime) {
    console.log('No previous submission found');
    return false;
  }
  
  const now = Date.now();
  const oneMinute = 1 * 60 * 1000; // 1 minute in milliseconds - FOR TESTING
  const timeDiff = now - parseInt(submissionTime);
  
  if (timeDiff > oneMinute) {
    console.log('Previous submission expired (older than 1 minute), removing it');
    localStorage.removeItem(key);
    return false;
  }
  
  console.log('Valid submission found within 1 minute');
  return true;
}

// Mark as submitted
function markSubmitted() {
  const key = 'submitted_' + getDeviceId() + '_' + getToday() + '_' + getPeriod();
  localStorage.setItem(key, Date.now().toString());
  console.log('Marked as submitted:', key);
}

// Show/hide functions
function showMessage(text, color) {
  console.log('Showing message:', text);
  document.getElementById('form-container').style.display = 'none';
  document.getElementById('message').style.display = 'block';
  document.getElementById('message').style.color = color || '#dc3545';
  document.getElementById('message').textContent = text;
}

function showForm() {
  console.log('Showing form');
  document.getElementById('form-container').style.display = 'block';
  document.getElementById('message').style.display = 'none';
}

// Main logic
function init() {
  console.log('=== INITIALIZING ===');
  
  // Clean up any expired submissions first
  cleanupExpiredSubmissions();
  
  const deviceId = getDeviceId();
  
  // Get current date and time (local time) - Original V1 logic
  const now = new Date();
  const currentHour = now.getHours();
  const currentDate = now.toLocaleDateString('en-CA'); // YYYY-MM-DD in local time
  const isMorningPeriod = currentHour >= 0 && currentHour < 12; // 6 AM - 9 AM
  const isEveningPeriod = currentHour >= 12 && currentHour <= 23; // 4 PM - 6 PM
  const isAllowedTime = isMorningPeriod || isEveningPeriod;
  const timePeriod = isMorningPeriod ? 'morning' : 'evening';
  
  console.log('Device ID:', deviceId);
  console.log('Current hour:', currentHour);
  console.log('Current date:', currentDate);
  console.log('Time period:', timePeriod);
  console.log('Is allowed time:', isAllowedTime);

  // Check if form can be shown - Original V1 logic
  if (!isAllowedTime) {
    showMessage('此表單僅在上午6點至9點和下午4點至6點開放。');
    console.log('Form blocked: Outside allowed time');
    return;
  }
  
  // Check if already submitted
  if (hasSubmitted()) {
    showMessage('您今天已經在此時段提交過表單。');
    return;
  }
  
  // Show form
  showForm();
  
  // Listen for messages
  window.addEventListener('message', function(event) {
    console.log('Message received:', event.data);
    if (event.data && typeof event.data === 'object' && event.data.type) {
      if (event.data.type.includes('submit') || event.data.type.includes('Submit')) {
        console.log('SUBMISSION DETECTED!');
        markSubmitted();
        showMessage('謝謝！表單提交成功。', '#228B22');
      }
    }
  });
}

// Start when page loads
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', init);
} else {
  init();
}

console.log('=== SCRIPT SETUP COMPLETE ===');
</script>
</body>
</html>
