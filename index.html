<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Uber Ride Form</title>
  <!-- Include FingerprintJS for device ID generation -->
  <script src="https://cdn.jsdelivr.net/npm/@fingerprintjs/fingerprintjs@3/dist/fp.min.js"></script>
</head>
<body>
  <h1 style="text-align: center;">Uber Ride Form</h1>
  <div id="form-container" style="max-width: 800px; margin: auto;">
    <!-- Replace YOUR_FORM_ID with your actual Fillout form ID -->
    <div data-fillout-id="pftwMqa9FDus" data-fillout-embed-type="standard" style="width:100%;height:500px;" id="fillout-form" data-fillout-inherit-parameters data-fillout-dynamic-resize></div>
    <script src="https://server.fillout.com/embed/v1/"></script>
  </div>
  <div id="error-message" style="color: red; display: none; text-align: center; max-width: 800px; margin: auto; font-size: 24px;"></div>

  <script>
    // Initialize FingerprintJS to get device ID
    FingerprintJS.load().then(fp => {
      fp.get().then(result => {
        const deviceId = result.visitorId; // Unique device ID
        const formContainer = document.getElementById('form-container');
        const errorMessage = document.getElementById('error-message');

        console.log('Device ID:', deviceId);

        // Get current Taiwan time
        const now = new Date();
        const taiwanTime = new Date(now.toLocaleString("en-US", {timeZone: "Asia/Taipei"}));
        const currentHour = taiwanTime.getHours();
        const currentDate = taiwanTime.toISOString().split('T')[0]; // YYYY-MM-DD
        
        console.log(`Taiwan time: ${currentHour}:${taiwanTime.getMinutes()} on ${currentDate}`);
        
        const isMorningPeriod = currentHour >= 6 && currentHour < 9; // 6 AM - 9 AM Taiwan time
        const isEveningPeriod = currentHour >= 16 && currentHour < 18; // 4 PM - 6 PM Taiwan time
        const isAllowedTime = isMorningPeriod || isEveningPeriod;
        const timePeriod = isMorningPeriod ? 'morning' : 'evening';

        // Check localStorage for submission data
        const submissionKey = `form_submission_${deviceId}_${currentDate}_${timePeriod}`;
        const lastSubmission = localStorage.getItem(submissionKey);
        const lastSubmissionDate = localStorage.getItem(`submission_date_${deviceId}`);
        
        console.log('Checking submission:', submissionKey, lastSubmission);

        // Reset submissions if it's a new day
        if (lastSubmissionDate !== currentDate) {
          localStorage.removeItem(`form_submission_${deviceId}_${currentDate}_morning`);
          localStorage.removeItem(`form_submission_${deviceId}_${currentDate}_evening`);
          localStorage.setItem(`submission_date_${deviceId}`, currentDate);
          console.log('Submissions reset for new day');
        }

        // Check if form can be shown
        if (!isAllowedTime) {
          formContainer.style.display = 'none';
          errorMessage.style.display = 'block';
          errorMessage.textContent = 'This form is only accessible from 6 AM–9 AM and 4 PM–6 PM Taiwan time.';
          console.log('Form blocked: Outside allowed time');
          return;
        }

        if (lastSubmission) {
          formContainer.style.display = 'none';
          errorMessage.style.display = 'block';
          errorMessage.textContent = `You have already submitted the form for the ${timePeriod} period today. Try again in the next period.`;
          console.log('Form blocked: Already submitted');
          return;
        }

        // Show the form
        formContainer.style.display = 'block';
        errorMessage.style.display = 'none';
        console.log('Form displayed');

        // Pass device ID to Fillout form as a hidden field
        setTimeout(() => {
          window.postMessage({
            type: 'filloutPrefill',
            field: 'deviceId',
            value: deviceId
          }, '*');
          console.log('Device ID sent to form:', deviceId);
        }, 2000);

        // Store submission timestamp on form submission
        window.addEventListener('message', (event) => {
          console.log('Received message:', event.data);
          
          // Check for various submission event types
          if (event.data && (
            event.data.type === 'filloutSubmission' ||
            event.data.type === 'formSubmission' ||
            event.data.type === 'fillout-form-submit'
          )) {
            console.log('*** FORM SUBMITTED ***');
            localStorage.setItem(submissionKey, Date.now().toString());
            localStorage.setItem(`submission_date_${deviceId}`, currentDate);
            console.log('Submission recorded:', submissionKey);
            
            // Hide form immediately
            formContainer.style.display = 'none';
            errorMessage.style.display = 'block';
            errorMessage.textContent = `Thank you! You have submitted the form for the ${timePeriod} period.`;
          }
        });
      });
    }).catch(error => {
      console.error('FingerprintJS failed:', error);
      // Fallback: generate simple UUID if FingerprintJS fails
      const fallbackId = 'fallback-' + Math.random().toString(36).substr(2, 9);
      console.log('Using fallback ID:', fallbackId);
      // Continue with same logic using fallbackId...
    });
  </script>
</body>
</html>
