<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Uber Ride Form</title>
  <style>
    body { font-family: Arial, sans-serif; }
    #form-container { max-width: 800px; margin: auto; }
    #error-message { color: red; text-align: center; font-size: 24px; }
  </style>
</head>
<body>
  <h1 style="text-align: center;">Uber Ride Form</h1>
  <div id="form-container">
    <div data-fillout-id="pftwMqa9FDus" data-fillout-embed-type="standard" style="width:100%;height:500px;" id="fillout-form" data-fillout-inherit-parameters data-fillout-dynamic-resize></div>
    <script src="https://server.fillout.com/embed/v1/"></script>
  </div>
  <div id="error-message" style="display: none;"></div>

  <script>
    // Generate or retrieve a persistent ID
    const generatePersistentId = () => {
      let persistentId = localStorage.getItem('persistent_id');
      if (!persistentId) {
        persistentId = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
          const r = Math.random() * 16 | 0;
          const v = c === 'x' ? r : (r & 0x3 | 0x8);
          return v.toString(16);
        });
        localStorage.setItem('persistent_id', persistentId);
        console.log('Generated persistent ID:', persistentId);
      } else {
        console.log('Retrieved persistent ID:', persistentId);
      }
      return persistentId;
    };

    const persistentId = generatePersistentId();
    const formContainer = document.getElementById('form-container');
    const errorMessage = document.getElementById('error-message');

    // Check submission status and update form visibility
    const checkSubmissionStatus = () => {
      const now = new Date();
      const currentDate = now.toLocaleString('en-CA', { timeZone: 'Asia/Taipei', year: 'numeric', month: '2-digit', day: '2-digit' }).replace(/\//g, '-');
      const currentHour = parseInt(now.toLocaleString('en-US', { timeZone: 'Asia/Taipei', hour: 'numeric', hour12: false }));
      // const isMorningPeriod = currentHour >= 6 && currentHour < 9;
      // const isEveningPeriod = currentHour >= 16 && currentHour < 18;
      // const isAllowedTime = isMorningPeriod || isEveningPeriod;
      const timePeriod = (currentHour >= 6 && currentHour < 9) ? 'morning' : 'evening';

      console.log('Current Date:', currentDate, 'Current Hour:', currentHour, 'Time Period:', timePeriod);

      const submissionKey = `form_submission_${persistentId}_${currentDate}_${timePeriod}`;
      const lastSubmission = localStorage.getItem(submissionKey);
      console.log('Checking localStorage - Submission Key:', submissionKey, 'Value:', lastSubmission);

      // Reset submissions for new day
      const lastSubmissionDate = localStorage.getItem(`submission_date_${persistentId}`);
      if (lastSubmissionDate !== currentDate) {
        localStorage.removeItem(`form_submission_${persistentId}_${currentDate}_morning`);
        localStorage.removeItem(`form_submission_${persistentId}_${currentDate}_evening`);
        localStorage.setItem(`submission_date_${persistentId}`, currentDate);
        console.log('Submissions reset for new day:', currentDate);
      }

      // // Check if within allowed time
      // if (!isAllowedTime) {
      //   formContainer.style.display = 'none';
      //   errorMessage.style.display = 'block';
      //   errorMessage.textContent = 'This form is only accessible from 6 AM–9 AM and 4 PM–6 PM Taiwan time.';
      //   console.log('Form blocked: Outside allowed time');
      //   return;
      // }

      if (lastSubmission) {
        formContainer.style.display = 'none';
        errorMessage.style.display = 'block';
        errorMessage.textContent = `You have already submitted the form for the ${timePeriod} period today. Try again tomorrow.`;
        console.log('Form blocked: Prior submission detected');
        return;
      }

      formContainer.style.display = 'block';
      errorMessage.style.display = 'none';
      console.log('Form displayed: No prior submission');
    };

    // Initial check
    checkSubmissionStatus();

    // Periodically check submission status
    setInterval(checkSubmissionStatus, 1000);

    // Prefill deviceId
    document.querySelector('[data-fillout-id]').addEventListener('load', () => {
      const form = document.querySelector('iframe[data-fillout-id]');
      if (form) {
        form.contentWindow.postMessage({
          type: 'filloutPrefill',
          field: 'deviceId',
          value: persistentId
        }, '*');
        console.log('Sent deviceId to form:', persistentId);
      } else {
        console.log('Error: Form iframe not found');
      }
    });

    // Detect form submission
    window.addEventListener('message', (event) => {
      console.log('Received postMessage:', event.data);
      if (event.data.type === 'filloutSubmission') {
        console.log('Submission detected via filloutSubmission');
        recordSubmission();
      }
    });

    // Fallback: Poll for submission confirmation
    document.querySelector('[data-fillout-id]').addEventListener('load', () => {
      const iframe = document.querySelector('iframe[data-fillout-id]');
      if (iframe) {
        console.log('Iframe loaded, starting polling');
        const pollSubmission = setInterval(() => {
          try {
            const iframeDocument = iframe.contentDocument;
            if (iframeDocument) {
              const successText = iframeDocument.querySelector('h1, h2, p, div[class*="success"], div[class*="confirmation"]')?.textContent.toLowerCase();
              if (successText && (successText.includes('thank you') || successText.includes('submitted') || successText.includes('success') || successText.includes('confirmation'))) {
                console.log('Submission detected via iframe content');
                recordSubmission();
                clearInterval(pollSubmission);
              }
            }
          } catch (error) {
            console.log('Error polling iframe:', error.message);
          }
        }, 1000);
      }
    });

    // Record submission in localStorage
    const recordSubmission = () => {
      const now = new Date();
      const currentDate = now.toLocaleString('en-CA', { timeZone: 'Asia/Taipei', year: 'numeric', month: '2-digit', day: '2-digit' }).replace(/\//g, '-');
      const currentHour = parseInt(now.toLocaleString('en-US', { timeZone: 'Asia/Taipei', hour: 'numeric', hour12: false }));
      const timePeriod = (currentHour >= 6 && currentHour < 9) ? 'morning' : 'evening';
      const submissionKey = `form_submission_${persistentId}_${currentDate}_${timePeriod}`;
      localStorage.setItem(submissionKey, Date.now().toString());
      localStorage.setItem(`submission_date_${persistentId}`, currentDate);
      console.log('Submission recorded - Key:', submissionKey, 'Value:', localStorage.getItem(submissionKey));
      checkSubmissionStatus();
    };
  </script>
</body>
</html>
