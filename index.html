<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Uber Ride Form</title>
</head>
<body>
  <h1 style="text-align: center;">Uber Ride Form</h1>
  
  <!-- Step 1: Basic Fillout Form Container -->
  <div id="form-container" style="max-width: 800px; margin: auto;">
    <div data-fillout-id="pftwMqa9FDus" 
         data-fillout-embed-type="standard" 
         style="width:100%;height:500px;" 
         id="fillout-form" 
         data-fillout-inherit-parameters 
         data-fillout-dynamic-resize>
    </div>
    <script src="https://server.fillout.com/embed/v1/"></script>
  </div>
  
  <!-- Error/Status Messages -->
  <div id="message" style="color: red; display: none; text-align: center; max-width: 800px; margin: auto; font-size: 18px; padding: 20px;"></div>

  <script>
    // Step 2: Generate Simple Device ID
    function getDeviceId() {
      let deviceId = localStorage.getItem('deviceId');
      if (!deviceId) {
        // Create simple but reliable device ID
        deviceId = 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('deviceId', deviceId);
      }
      return deviceId;
    }

    // Step 3: Get Taiwan Time
    function getTaiwanTime() {
      const now = new Date();
      const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
      const taiwanTime = new Date(utc + (8 * 3600000)); // UTC+8
      return taiwanTime;
    }

    // Step 4: Check Time Restrictions
    function isAllowedTime() {
      const taiwanTime = getTaiwanTime();
      const hour = taiwanTime.getHours();
      
      const isMorning = hour >= 6 && hour < 9;   // 6 AM - 9 AM
      const isEvening = hour >= 16 && hour < 18; // 4 PM - 6 PM
      
      return isMorning || isEvening;
    }

    // Step 5: Check if Already Submitted
    function hasSubmittedToday() {
      const deviceId = getDeviceId();
      const taiwanTime = getTaiwanTime();
      const today = taiwanTime.toISOString().split('T')[0]; // YYYY-MM-DD
      const hour = taiwanTime.getHours();
      const period = (hour >= 6 && hour < 9) ? 'morning' : 'evening';
      
      const submissionKey = `submitted_${deviceId}_${today}_${period}`;
      return localStorage.getItem(submissionKey) !== null;
    }

    // Step 6: Mark as Submitted
    function markAsSubmitted() {
      const deviceId = getDeviceId();
      const taiwanTime = getTaiwanTime();
      const today = taiwanTime.toISOString().split('T')[0];
      const hour = taiwanTime.getHours();
      const period = (hour >= 6 && hour < 9) ? 'morning' : 'evening';
      
      const submissionKey = `submitted_${deviceId}_${today}_${period}`;
      localStorage.setItem(submissionKey, Date.now().toString());
    }

    // Step 7: Show/Hide Elements
    function showMessage(text, color = 'red') {
      const message = document.getElementById('message');
      message.textContent = text;
      message.style.color = color;
      message.style.display = 'block';
      document.getElementById('form-container').style.display = 'none';
    }

    function showForm() {
      document.getElementById('form-container').style.display = 'block';
      document.getElementById('message').style.display = 'none';
    }

    // Step 8: Main Logic
    function initializeForm() {
      const deviceId = getDeviceId();
      console.log('Device ID:', deviceId);
      console.log('Taiwan Time:', getTaiwanTime().toLocaleString());

      // COMMENTED OUT FOR TESTING - Time restrictions
      /*
      if (!isAllowedTime()) {
        showMessage('This form is only accessible from 6 AM–9 AM and 4 PM–6 PM Taiwan time.');
        return;
      }
      */

      // COMMENTED OUT FOR TESTING - Submission check
      
      if (hasSubmittedToday()) {
        showMessage('You have already submitted the form for this period today.');
        return;
      }
      

      // Show the form
      showForm();

      // Listen for form submission
      window.addEventListener('message', (event) => {
        if (event.data && (
          event.data.type === 'filloutSubmission' ||
          event.data.type === 'formSubmission' ||
          event.data.type === 'fillout-form-submit'
        )) {
          console.log('Form submitted!');
          markAsSubmitted();
          showMessage('Thank you! Your form has been submitted.', 'green');
        }
      });
    }

    // Start when page loads
    document.addEventListener('DOMContentLoaded', initializeForm);
  </script>
</body>
</html>
